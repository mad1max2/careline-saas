<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CareLine Driver Performance</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --teal: #0097a7;
      --dark: #004d40;
      --bg: #e0f7fa;
      --card: #ffffff;
      --muted: #607d8b;
      --danger: #c62828;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--dark);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: var(--teal);
      color: #fff;
      padding: 12px 18px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .brand {
      font-weight: bold;
      font-size: 17px;
    }

    .subtitle {
      font-size: 11px;
      opacity: 0.9;
    }

    .nav {
      display: flex;
      gap: 10px;
      font-size: 12px;
    }

    .nav a {
      color: #e0f7fa;
      text-decoration: none;
      padding: 4px 8px;
      border-radius: 999px;
    }

    .nav a:hover {
      background: rgba(255,255,255,0.15);
    }

    .nav a.active {
      background: rgba(255,255,255,0.2);
    }

    main {
      flex: 1;
      padding: 14px;
      max-width: 1100px;
      width: 100%;
      margin: 0 auto;
    }

    h1 {
      font-size: 20px;
      margin-bottom: 4px;
    }

    .small {
      font-size: 11px;
      color: var(--muted);
    }

    .top-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 10px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .card {
      background: var(--card);
      border-radius: 12px;
      padding: 10px 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      margin-bottom: 12px;
    }

    label {
      display: block;
      font-size: 12px;
      margin-bottom: 3px;
      color: #455a64;
    }

    select, input {
      padding: 7px 9px;
      border-radius: 8px;
      border: 1px solid #b0bec5;
      font-size: 13px;
      margin-bottom: 6px;
      width: 100%;
      max-width: 250px;
    }

    button {
      font-size: 12px;
      padding: 7px 11px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
    }

    button.primary {
      background: var(--teal);
      color: #ffffff;
      font-weight: 600;
    }

    button.secondary {
      background: #eceff1;
      color: var(--dark);
    }

    button:active {
      transform: scale(0.98);
    }

    .error {
      padding: 8px;
      background: #ffebee;
      color: var(--danger);
      border-radius: 8px;
      font-size: 12px;
      margin-bottom: 8px;
      display: none;
    }

    .session-pill {
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
      margin-top: 8px;
      margin-bottom: 8px;
    }

    .stat-card {
      background: #f5f5f5;
      border-radius: 10px;
      padding: 8px 10px;
      text-align: left;
    }

    .stat-label {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 2px;
    }

    .stat-value {
      font-size: 18px;
      font-weight: bold;
    }

    .stat-sub {
      font-size: 11px;
      color: var(--muted);
      margin-top: 2px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #eceff1;
      text-align: left;
    }

    th {
      font-weight: 600;
      font-size: 11px;
      color: #455a64;
      white-space: nowrap;
    }

    tr:nth-child(even) {
      background: #fafafa;
    }

    .status-pill {
      display: inline-block;
      border-radius: 999px;
      padding: 2px 7px;
      font-size: 11px;
      background: #eceff1;
      color: #455a64;
    }

    .status-complete {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .status-pending {
      background: #fff3e0;
      color: #e65100;
    }

    .count-pill {
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px;
    }

    footer {
      font-size: 11px;
      text-align: center;
      padding: 8px 10px;
      color: var(--muted);
    }

    @media (max-width: 900px) {
      .stats-grid {
        grid-template-columns: 1fr 1fr;
      }
    }

    @media (max-width: 600px) {
      .stats-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <header>
    <div>
      <div class="brand">CareLine Medical Logistics</div>
      <div class="subtitle">Driver Performance</div>
    </div>
    <nav class="nav" id="mainNav"></nav>
  </header>

  <main>
    <div class="top-row">
      <div>
        <h1>Driver Performance Metrics</h1>
        <p class="small">
          Select a driver to see assigned stops, completion rates, and notification activity.
        </p>
        <p class="session-pill" id="sessionUser">Checking current sessionâ€¦</p>
      </div>

      <section class="card" style="max-width:340px;">
        <h2 style="font-size:14px;margin-bottom:4px;">Select Driver</h2>
        <p class="small" style="margin-bottom:6px;">
          Choose from known drivers (from routes.json) or enter a driver ID manually.
        </p>

        <div id="driverPerfError" class="error"></div>

        <label for="driverSelect">Driver (from routes.json)</label>
        <select id="driverSelect">
          <option value="">-- Select driver --</option>
        </select>

        <label for="driverManual">Or type driver ID</label>
        <input id="driverManual" type="text" placeholder="e.g. driver1" />

        <button id="applyDriverBtn" class="primary" style="margin-top:4px;">Apply</button>
      </section>
    </div>

    <section class="card">
      <h2 style="font-size:14px;margin-bottom:4px;">Overview</h2>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">Total assigned stops</div>
          <div class="stat-value" id="statTotalStops">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Completed stops</div>
          <div class="stat-value" id="statCompletedStops">0</div>
          <div class="stat-sub" id="statCompletedPct"></div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Pending stops</div>
          <div class="stat-value" id="statPendingStops">0</div>
          <div class="stat-sub" id="statPendingInfo"></div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Notification events</div>
          <div class="stat-value" id="statEventCount">0</div>
          <div class="stat-sub" id="statEventInfo"></div>
        </div>
      </div>
      <p class="small">
        Completion status is based on the stopâ€™s <strong>status</strong> text. Words like
        "delivered", "completed", or "done" are counted as complete.
      </p>
    </section>

    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
        <h2 style="font-size:14px;">Stops & Activity</h2>
        <button id="refreshBtn" class="secondary">Refresh</button>
      </div>

      <table>
        <thead>
          <tr>
            <th>Stop ID</th>
            <th>Patient</th>
            <th>Facility</th>
            <th>Status</th>
            <th>Events</th>
            <th>Last Event</th>
          </tr>
        </thead>
        <tbody id="stopsBody">
        </tbody>
      </table>
      <p class="count-pill" id="stopsCount">No driver selected yet.</p>
    </section>
  </main>

  <footer>
    CareLine Medical Logistics â€” Care That Moves. Logistics That Deliver.
  </footer>

  <script src="/js/careline-universal.js"></script>
  <script src="nav.js"></script>
  <script>
    function isCompleteStatus(statusRaw) {
      if (!statusRaw) return false;
      const s = statusRaw.toLowerCase();
      const completeWords = ['done', 'delivered', 'completed', 'complete', 'closed'];
      return completeWords.some(word => s.includes(word));
    }

    async function loadDriversIntoSelect() {
      try {
        const data = await carelineApiGet('/routes.json');
        const drivers = data.drivers || [];
        const select = document.getElementById('driverSelect');
        select.innerHTML = '<option value="">-- Select driver --</option>';

        const seen = new Set();
        drivers.forEach(d => {
          if (!d.id || seen.has(d.id)) return;
          seen.add(d.id);
          const opt = document.createElement('option');
          opt.value = d.id;
          opt.textContent = d.id + (d.name ? ' â€” ' + d.name : '');
          select.appendChild(opt);
        });
      } catch (err) {
        console.error('Error loading drivers', err);
      }
    }

    async function loadDriverPerformance(driverId) {
      const errBox = document.getElementById('driverPerfError');
      const stopsBody = document.getElementById('stopsBody');
      const stopsCount = document.getElementById('stopsCount');

      errBox.style.display = 'none';
      errBox.textContent = '';
      stopsBody.innerHTML = '';

      if (!driverId) {
        stopsCount.textContent = 'No driver selected yet.';
        return;
      }

      try {
        const [routesRes, notifyRes] = await Promise.all([
          carelineApiGet('/routes.json'),
          carelineApiGet('/api/notifications')
        ]);

        const routes = routesRes.routes || [];
        const notifications = notifyRes.notifications || [];

        const myStops = [];
        routes
          .filter(r => r.driverId === driverId)
          .forEach(route => {
            (route.stops || []).forEach(stop => {
              myStops.push(stop);
            });
          });

        if (!myStops.length) {
          stopsCount.textContent = 'No stops found for driverId "' + driverId + '".';
        }

        const eventsByStop = {};
        notifications.forEach(ev => {
          if (ev.driverId !== driverId) return;
          const stopId = ev.stopId || '(no stop id)';
          if (!eventsByStop[stopId]) {
            eventsByStop[stopId] = { count: 0, lastEventTime: null };
          }
          eventsByStop[stopId].count++;
          if (ev.createdAt) {
            const ts = new Date(ev.createdAt).getTime();
            const current = eventsByStop[stopId].lastEventTime
              ? new Date(eventsByStop[stopId].lastEventTime).getTime()
              : 0;
            if (ts > current) {
              eventsByStop[stopId].lastEventTime = ev.createdAt;
            }
          }
        });

        let totalStops = myStops.length;
        let completed = 0;

        myStops.forEach(stop => {
          if (isCompleteStatus(stop.status || '')) completed++;
        });

        const pending = totalStops - completed;
        const eventCount = notifications.filter(ev => ev.driverId === driverId).length;

        document.getElementById('statTotalStops').textContent = totalStops;
        document.getElementById('statCompletedStops').textContent = completed;
        document.getElementById('statPendingStops').textContent = pending;
        document.getElementById('statEventCount').textContent = eventCount;

        if (totalStops > 0) {
          const pct = Math.round((completed / totalStops) * 100);
          document.getElementById('statCompletedPct').textContent = pct + '% complete';
          document.getElementById('statPendingInfo').textContent =
            pending > 0 ? pending + ' stop(s) remaining' : 'All assigned stops completed ðŸŽ‰';
        } else {
          document.getElementById('statCompletedPct').textContent = '';
          document.getElementById('statPendingInfo').textContent = '';
        }

        document.getElementById('statEventInfo').textContent =
          eventCount + ' total event(s) logged for this driver.';

        myStops.forEach(stop => {
          const stopId = stop.stopId || '';
          const status = stop.status || '';
          const complete = isCompleteStatus(status);
          const evInfo = eventsByStop[stopId] || { count: 0, lastEventTime: null };

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${stopId}</td>
            <td>${stop.patientName || ''}</td>
            <td>${stop.location || ''}</td>
            <td>
              <span class="status-pill ${complete ? 'status-complete' : 'status-pending'}">
                ${status || (complete ? 'Delivered' : 'Pending')}
              </span>
            </td>
            <td>${evInfo.count}</td>
            <td>${evInfo.lastEventTime ? carelineFormatDateTimeShort(evInfo.lastEventTime) : 'â€”'}</td>
          `;
          stopsBody.appendChild(tr);
        });

        if (totalStops > 0) {
          stopsCount.textContent = 'Showing ' + totalStops + ' stop(s) for driverId "' + driverId + '".';
        }
      } catch (err) {
        console.error('Error loading driver performance', err);
        errBox.style.display = 'block';
        errBox.textContent = 'Error loading performance data: ' + err.message;
      }
    }

    document.getElementById('applyDriverBtn').addEventListener('click', () => {
      const select = document.getElementById('driverSelect');
      const manual = document.getElementById('driverManual');
      const errBox = document.getElementById('driverPerfError');

      errBox.style.display = 'none';
      errBox.textContent = '';

      const fromSelect = select.value || '';
      const fromManual = manual.value.trim();
      const driverId = fromManual || fromSelect;

      if (!driverId) {
        errBox.style.display = 'block';
        errBox.textContent = 'Please select or enter a driver ID.';
        return;
      }

      localStorage.setItem('carelinePerfDriverId', driverId);
      loadDriverPerformance(driverId);
    });

    document.getElementById('refreshBtn').addEventListener('click', () => {
      const saved = localStorage.getItem('carelinePerfDriverId') || '';
      if (!saved) {
        document.getElementById('stopsCount').textContent = 'No driver selected yet.';
        return;
      }
      loadDriverPerformance(saved);
    });

    // Boot
    requireLoggedIn();
    buildRoleAwareNav('driver-performance');
    updateSessionLabel();
    loadDriversIntoSelect();

    const lastDriver = localStorage.getItem('carelinePerfDriverId') || '';
    if (lastDriver) {
      document.getElementById('driverManual').value = lastDriver;
      loadDriverPerformance(lastDriver);
    }
  </script>
</body>
</html>
