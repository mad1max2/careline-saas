<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Driver Route | CareLine Medical Logistics</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f2f7f9;
      margin: 0;
      padding: 0;
    }
    header {
      background-color: #0097a7;
      color: white;
      text-align: center;
      padding: 20px 0;
      font-size: 22px;
      font-weight: bold;
    }
    .driver-select {
      max-width: 700px;
      margin: 15px auto 10px;
      background: #ffffff;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      font-size: 15px;
      color: #006064;
    }
    .driver-select select {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      font-size: 15px;
      border: 1px solid #b0bec5;
      margin-top: 6px;
    }
    .route-container {
      max-width: 700px;
      margin: 10px auto 20px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      padding: 18px 18px 20px;
    }
    .route-info {
      background-color: #f1fbfc;
      border-radius: 8px;
      border: 1px solid #cfd8dc;
      padding: 10px 12px;
      margin-bottom: 14px;
      font-size: 13px;
      color: #455a64;
    }
    .route-info-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }
    .route-name {
      font-size: 15px;
      font-weight: bold;
      color: #004d60;
    }
    .route-meta {
      font-size: 12px;
      color: #607d8b;
    }
    .route-notes {
      font-size: 12px;
      color: #607d8b;
      margin-top: 2px;
    }
    .stop {
      background: #e0f7fa;
      margin-bottom: 15px;
      border-radius: 8px;
      padding: 15px;
      cursor: pointer;
    }
    .stop h3 {
      margin: 0;
      color: #00796b;
    }
    .details {
      display: none;
      padding-top: 10px;
    }
    .show { display: block; }
    .details p {
      margin: 4px 0;
    }
    .status-select-label {
      font-size: 14px;
      margin-top: 6px;
      color: #004d60;
    }
    .status-select {
      width: 100%;
      margin-top: 2px;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #b0bec5;
      font-size: 13px;
    }
    button.upload-proof {
      background-color: #0097a7;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 10px;
    }
    button.upload-proof:hover {
      background-color: #007b83;
    }
    .thumbnail img {
      margin-top: 10px;
      border-radius: 8px;
      width: 120px;
    }
    .customer-link {
      display: inline-block;
      margin-top: 8px;
      text-decoration: none;
      background-color: white;
      border: 1px solid #0097a7;
      color: #0097a7;
      padding: 7px 12px;
      border-radius: 6px;
      font-size: 13px;
      margin-right: 4px;
    }
    .no-route {
      text-align: center;
      color: #607d8b;
      font-size: 14px;
      padding-top: 8px;
    }
  </style>
</head>
<body>

<header>
  üöö CareLine Driver Route
</header>

<div class="driver-select">
  <strong>Who is driving?</strong>
  <select id="driverName">
    <option>Max (CareLine Driver)</option>
    <option>Lena (CareLine Driver)</option>
    <option>Chris (CareLine Driver)</option>
    <option>James (CareLine Driver)</option>
  </select>
</div>

<div class="route-container">
  <div id="routeInfo" class="route-info">
    Loading route info...
  </div>
  <div id="routeStops">
    Loading route...
  </div>
</div>

<script>
  let allStops = [];
  let routeMeta = {};

  function getDriverName() {
    return document.getElementById("driverName").value;
  }

  function toggleDetails(id) {
    document.querySelectorAll('.details').forEach(d => d.classList.remove('show'));
    const el = document.getElementById(id);
    if (el) el.classList.add('show');
  }

  function formatStatusText(status) {
    if (status === 'Delivered') return 'Status: Delivered ‚úîÔ∏è';
    if (status === 'Attempted - No Answer') return 'Status: Attempted ‚Äì No Answer ‚ö†Ô∏è';
    if (status === 'Left with Staff') return 'Status: Left with Staff üßë‚Äç‚öïÔ∏è';
    return 'Status: ' + status;
  }

  async function uploadProof(event, stopId, facilityName) {
    event.stopPropagation();

    const driver = getDriverName();
    const statusSelect = document.getElementById("statusSelect-" + stopId);
    const chosenStatus = statusSelect ? statusSelect.value : 'Delivered';

    const input = document.createElement("input");
    input.type = "file";
    input.accept = "image/*";
    input.capture = "environment";

    input.onchange = async () => {
      const file = input.files[0];
      if (!file) return;

      let gps = { lat: null, lng: null };
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          pos => {
            gps.lat = pos.coords.latitude;
            gps.lng = pos.coords.longitude;
          }
        );
      }

      await new Promise(r => setTimeout(r, 800));

      const formData = new FormData();
      formData.append("photo", file);
      formData.append("stopId", stopId);
      formData.append("timestamp", new Date().toISOString());
      formData.append("lat", gps.lat);
      formData.append("lng", gps.lng);
      formData.append("facilityName", facilityName);
      formData.append("driverName", driver);
      formData.append("status", chosenStatus);

      const res = await fetch("http://localhost:3000/uploadProof", {
        method: "POST",
        body: formData
      });

      const data = await res.json();
      alert("üì∏ Delivery Uploaded!");

      const thumbEl = document.getElementById("thumb-" + stopId);
      const statusTextEl = document.getElementById("statusText-" + stopId);
      const trackingEl = document.getElementById("tracking-" + stopId);
      const customerLinkEl = document.getElementById("link-" + stopId);
      const clinicLinkEl = document.getElementById("clinic-" + stopId);

      if (thumbEl) {
        thumbEl.innerHTML = `<img src="${data.fileUrl}">`;
      }
      if (statusTextEl) {
        statusTextEl.innerText = formatStatusText(data.status || chosenStatus);
      }
      if (trackingEl) {
        trackingEl.innerText = "Tracking ID: " + data.trackingCode;
      }
      if (customerLinkEl) {
        customerLinkEl.href = `tracking.html?code=${encodeURIComponent(data.trackingCode)}`;
      }
      if (clinicLinkEl) {
        clinicLinkEl.href = `tracking-hospital.html?code=${encodeURIComponent(data.trackingCode)}`;
      }
    };

    input.click();
  }

  function buildRouteUI() {
    const routeInfoEl = document.getElementById('routeInfo');
    const stopsContainer = document.getElementById('routeStops');
    const currentDriver = getDriverName();

    // Route header
    const name = routeMeta.routeName || 'CareLine Route';
    const date = routeMeta.routeDate || '';
    const dispatcher = routeMeta.dispatcher || '';
    const notes = routeMeta.notes || '';

    // Filter stops by driver
    let filtered = allStops;
    if (currentDriver && filtered && filtered.length > 0) {
      filtered = filtered.filter(stop => {
        if (!stop.drivers || !Array.isArray(stop.drivers) || stop.drivers.length === 0) {
          return true; // no drivers field = all drivers
        }
        return stop.drivers.includes(currentDriver);
      });
    }

    const stopCount = filtered.length;

    routeInfoEl.innerHTML = `
      <div class="route-info-top">
        <div class="route-name">${name}</div>
        <div class="route-meta">
          ${date ? `Date: ${date}` : ''}${date && dispatcher ? ' ¬∑ ' : ''}${dispatcher ? `Dispatcher: ${dispatcher}` : ''}
        </div>
      </div>
      <div class="route-meta">
        Assigned driver: <strong>${currentDriver}</strong> ¬∑ Stops on this route: <strong>${stopCount}</strong>
      </div>
      ${notes ? `<div class="route-notes">${notes}</div>` : ''}
    `;

    if (!filtered || filtered.length === 0) {
      stopsContainer.innerHTML = `
        <div class="no-route">
          No stops assigned to <strong>${currentDriver}</strong> on this route.<br>
          Check routes.json or choose a different driver.
        </div>
      `;
      return;
    }

    // Build stops
    stopsContainer.innerHTML = '';
    filtered.forEach(stop => {
      const safeFacility = (stop.facility || '').replace(/'/g, "\\'");
      const html = `
        <div class="stop" onclick="toggleDetails('${stop.id}')">
          <h3>${stop.title}</h3>
          <div class="details" id="${stop.id}">
            <p><strong>Facility:</strong> ${stop.facility}</p>
            <p><strong>Items:</strong> ${stop.items}</p>
            <p id="statusText-${stop.id}">Status: Not Delivered ‚ùå</p>
            <p id="tracking-${stop.id}">Tracking ID: ‚Äî</p>

            <div class="status-select-label">Delivery Status:</div>
            <select id="statusSelect-${stop.id}" class="status-select">
              <option value="Delivered">Delivered</option>
              <option value="Attempted - No Answer">Attempted ‚Äì No Answer</option>
              <option value="Left with Staff">Left with Staff</option>
            </select>

            <div class="thumbnail" id="thumb-${stop.id}"></div>
            <button class="upload-proof" onclick="uploadProof(event, '${stop.id}', '${safeFacility}')">
              üì∏ Upload Proof
            </button>
            <a id="link-${stop.id}" class="customer-link" href="#" target="_blank">View Customer</a>
            <a id="clinic-${stop.id}" class="customer-link" href="#" target="_blank">Facility View</a>
          </div>
        </div>
      `;
      stopsContainer.insertAdjacentHTML('beforeend', html);
    });
  }

  async function loadStops() {
    const routeInfoEl = document.getElementById('routeInfo');
    const stopsContainer = document.getElementById('routeStops');

    routeInfoEl.textContent = 'Loading route info...';
    stopsContainer.textContent = 'Loading route...';

    try {
      const res = await fetch('http://localhost:3000/routes.json');
      if (!res.ok) throw new Error('Unable to load routes.json');
      const data = await res.json();
      allStops = data.stops || [];
      routeMeta = data;
      buildRouteUI();
    } catch (err) {
      console.error(err);
      routeInfoEl.textContent = 'Unable to load route info.';
      stopsContainer.innerHTML = '<div class="no-route">Unable to load route definition (routes.json).</div>';
    }
  }

  window.addEventListener('load', () => {
    loadStops();
    const driverSelect = document.getElementById('driverName');
    driverSelect.addEventListener('change', buildRouteUI);
  });
</script>

</body>
</html>
