<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CareLine Facility Report</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --teal: #0097a7;
      --dark: #004d40;
      --bg: #e0f7fa;
      --card: #ffffff;
      --muted: #607d8b;
      --danger: #c62828;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--dark);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: var(--teal);
      color: #fff;
      padding: 12px 18px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .brand {
      font-weight: bold;
      font-size: 17px;
    }

    .subtitle {
      font-size: 11px;
      opacity: 0.9;
    }

    .nav {
      display: flex;
      gap: 10px;
      font-size: 12px;
    }

    .nav a {
      color: #e0f7fa;
      text-decoration: none;
      padding: 4px 8px;
      border-radius: 999px;
    }

    .nav a.active {
      background: rgba(255,255,255,0.2);
    }

    main {
      flex: 1;
      padding: 14px;
      max-width: 1100px;
      width: 100%;
      margin: 0 auto;
    }

    h1 {
      font-size: 20px;
      margin-bottom: 4px;
    }

    .small {
      font-size: 11px;
      color: var(--muted);
    }

    .session-pill {
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px;
    }

    .top-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 10px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .card {
      background: var(--card);
      border-radius: 12px;
      padding: 10px 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      margin-bottom: 12px;
    }

    .error {
      padding: 8px;
      background: #ffebee;
      color: var(--danger);
      border-radius: 8px;
      font-size: 12px;
      margin-bottom: 8px;
      display: none;
    }

    label {
      font-size: 12px;
      color: #455a64;
      margin-right: 4px;
    }

    input[type="date"],
    input[type="text"] {
      padding: 7px 9px;
      border-radius: 8px;
      border: 1px solid #b0bec5;
      font-size: 13px;
    }

    button {
      font-size: 12px;
      padding: 7px 11px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
    }

    button.primary {
      background: var(--teal);
      color: #ffffff;
      font-weight: 600;
    }

    button.secondary {
      background: #eceff1;
      color: var(--dark);
    }

    button:active {
      transform: scale(0.98);
    }

    .filters-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-top: 4px;
      margin-bottom: 4px;
    }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      margin-top: 8px;
      margin-bottom: 8px;
    }

    .metric-card {
      background: #f5f5f5;
      border-radius: 10px;
      padding: 8px 10px;
    }

    .metric-label {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 2px;
    }

    .metric-value {
      font-size: 18px;
      font-weight: bold;
    }

    .metric-sub {
      font-size: 11px;
      color: var(--muted);
      margin-top: 2px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      margin-top: 6px;
    }

    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #eceff1;
      text-align: left;
      vertical-align: top;
    }

    th {
      font-weight: 600;
      font-size: 11px;
      color: #455a64;
      white-space: nowrap;
    }

    tr:nth-child(even) {
      background: #fafafa;
    }

    .bar-cell {
      width: 40%;
    }

    .bar {
      height: 8px;
      border-radius: 999px;
      background: #b2ebf2;
      overflow: hidden;
    }

    .bar-fill {
      height: 100%;
      border-radius: 999px;
      background: var(--teal);
      width: 0%;
    }

    .count-pill {
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px;
    }

    footer {
      font-size: 11px;
      text-align: center;
      padding: 8px 10px;
      color: var(--muted);
    }

    @media (max-width: 900px) {
      .metrics-grid {
        grid-template-columns: 1fr 1fr;
      }
    }

    @media (max-width: 700px) {
      .metrics-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <header>
    <div>
      <div class="brand">CareLine Medical Logistics</div>
      <div class="subtitle">Facility Report</div>
    </div>
    <nav class="nav" id="mainNav"></nav>
  </header>

  <main>
    <div class="top-row">
      <div>
        <h1>Facility Performance Report</h1>
        <p class="small">
          On-time rate, volume, and delivery durations for a single facility.
        </p>
        <p class="session-pill" id="sessionUser">Checking current session…</p>
      </div>

      <section class="card" style="max-width:410px;">
        <h2 style="font-size:14px;margin-bottom:4px;">Filters</h2>
        <div id="frError" class="error"></div>

        <div class="filters-row">
          <div>
            <label for="facilityNameInput">Facility name contains</label><br />
            <input id="facilityNameInput" type="text" placeholder="Facility name..." />
          </div>
        </div>

        <div class="filters-row">
          <div>
            <label for="startDate">From</label>
            <input type="date" id="startDate" />
          </div>
          <div>
            <label for="endDate">To</label>
            <input type="date" id="endDate" />
          </div>
        </div>

        <div class="filters-row">
          <button id="applyBtn" class="primary">Apply</button>
          <button id="resetBtn" class="secondary">Reset</button>
        </div>
      </section>
    </div>

    <section class="card">
      <h2 style="font-size:14px;margin-bottom:4px;">Summary</h2>
      <div class="metrics-grid">
        <div class="metric-card">
          <div class="metric-label">On-time rate</div>
          <div class="metric-value" id="metricOnTime">0%</div>
          <div class="metric-sub" id="metricOnTimeSub"></div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Distinct stops</div>
          <div class="metric-value" id="metricStops">0</div>
          <div class="metric-sub" id="metricStopsSub"></div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Avg delivery duration</div>
          <div class="metric-value" id="metricDuration">0 min</div>
          <div class="metric-sub" id="metricDurationSub"></div>
        </div>
      </div>
    </section>

    <section class="card">
      <h2 style="font-size:14px;margin-bottom:4px;">Delivery Details</h2>
      <p class="small">
        One row per stop with schedule, delivery time, and duration (where data is available).
      </p>

      <table>
        <thead>
          <tr>
            <th>Stop ID</th>
            <th>Patient</th>
            <th>Scheduled</th>
            <th>Delivered</th>
            <th>On-time?</th>
            <th>Duration (min)</th>
            <th class="bar-cell">Bar</th>
          </tr>
        </thead>
        <tbody id="stopsBody"></tbody>
      </table>
      <p class="count-pill" id="stopsCount">No stops yet.</p>
    </section>
  </main>

  <footer>
    CareLine Medical Logistics — Care That Moves. Logistics That Deliver.
  </footer>

  <script src="/js/careline-universal.js"></script>
  <script src="nav.js"></script>
  <script>
    function buildBarFill(widthPct) {
      const w = Math.max(0, Math.min(100, widthPct));
      return '<div class="bar"><div class="bar-fill" style="width:' + w + '%;"></div></div>';
    }

    function isCompleteStatus(status, eventType) {
      const s = (status || '').toLowerCase();
      const e = (eventType || '').toLowerCase();
      const words = ['delivered', 'completed', 'complete', 'done', 'closed'];
      return words.some(w => s.includes(w) || e.includes(w));
    }

    function findScheduledFromTemplates(t) {
      if (!t) return null;
      if (t.scheduledTime) return new Date(t.scheduledTime);
      if (t.scheduledWindowEnd) return new Date(t.scheduledWindowEnd);
      if (t.windowEnd) return new Date(t.windowEnd);
      return null;
    }

    async function loadFacilityReport() {
      const errBox = document.getElementById('frError');
      errBox.style.display = 'none';
      errBox.textContent = '';

      const facilityFilter = document.getElementById('facilityNameInput').value.trim().toLowerCase();
      const startVal = document.getElementById('startDate').value;
      const endVal = document.getElementById('endDate').value;
      const startDate = carelineParseInputDate(startVal, false);
      const endDate = carelineParseInputDate(endVal, true);

      const stopsBody = document.getElementById('stopsBody');
      const stopsCount = document.getElementById('stopsCount');
      stopsBody.innerHTML = '';
      stopsCount.textContent = 'Loading…';

      try {
        const [notifyRes, routesRes] = await Promise.all([
          carelineApiGet('/api/notifications'),
          carelineApiGet('/routes.json')
        ]);

        const notifications = notifyRes.notifications || [];
        const routes = routesRes.routes || [];

        // Filter events to matching facility/date
        const events = notifications.filter(ev => {
          if (!ev.createdAt) return false;
          const d = new Date(ev.createdAt);
          if (isNaN(d.getTime())) return false;
          if (startDate && d < startDate) return false;
          if (endDate && d > endDate) return false;

          const t = ev.templates || {};
          const facilityName = (t.facilityName || '').toLowerCase();
          if (facilityFilter && !facilityName.includes(facilityFilter)) return false;

          return true;
        });

        if (!events.length) {
          stopsCount.textContent = 'No events for this facility / date range.';
        }

        // Map stop -> events
        const eventsByStop = {};
        events.forEach(ev => {
          const stopId = ev.stopId || '';
          if (!stopId) return;
          if (!eventsByStop[stopId]) eventsByStop[stopId] = [];
          eventsByStop[stopId].push(ev);
        });

        const perStop = [];
        Object.keys(eventsByStop).forEach(stopId => {
          const stopEvents = eventsByStop[stopId].slice().sort((a, b) => {
            const ta = a.createdAt ? new Date(a.createdAt).getTime() : 0;
            const tb = b.createdAt ? new Date(b.createdAt).getTime() : 0;
            return ta - tb;
          });

          if (!stopEvents.length) return;

          let scheduled = null;
          let deliveredAt = null;
          let patientName = '';
          let facilityName = '';

          stopEvents.forEach(ev => {
            const t = ev.templates || {};
            const cand = findScheduledFromTemplates(t);
            if (cand && !isNaN(cand.getTime())) {
              if (!scheduled || cand.getTime() < scheduled.getTime()) {
                scheduled = cand;
              }
            }
            if (!patientName && t.patientName) patientName = t.patientName;
            if (!facilityName && t.facilityName) facilityName = t.facilityName;
          });

          for (let i = stopEvents.length - 1; i >= 0; i--) {
            const ev = stopEvents[i];
            if (isCompleteStatus(ev.status, ev.eventType) && ev.createdAt) {
              const d = new Date(ev.createdAt);
              if (!isNaN(d.getTime())) {
                deliveredAt = d;
                break;
              }
            }
          }

          let durationMin = null;
          if (deliveredAt) {
            const firstEv = stopEvents[0];
            if (firstEv && firstEv.createdAt) {
              const start = new Date(firstEv.createdAt);
              if (!isNaN(start.getTime())) {
                durationMin = Math.round((deliveredAt.getTime() - start.getTime()) / 60000);
                if (durationMin < 0) durationMin = null;
              }
            }
          }

          let onTime = null;
          const graceMinutes = 15;
          if (scheduled && deliveredAt) {
            const diff = (deliveredAt.getTime() - scheduled.getTime()) / 60000;
            onTime = diff <= graceMinutes;
          }

          perStop.push({
            stopId,
            patientName,
            facilityName,
            scheduled,
            deliveredAt,
            durationMin,
            onTime
          });
        });

        if (!perStop.length) {
          stopsCount.textContent = 'No stops with schedule/delivery data in this range.';
        }

        perStop.sort((a, b) => {
          const ta = a.deliveredAt ? a.deliveredAt.getTime() : 0;
          const tb = b.deliveredAt ? b.deliveredAt.getTime() : 0;
          return tb - ta;
        });

        const durations = perStop
          .map(s => s.durationMin)
          .filter(v => v != null);
        const avgDuration =
          durations.length
            ? Math.round(durations.reduce((sum, v) => sum + v, 0) / durations.length)
            : 0;

        const stopsWithOnTime = perStop.filter(s => s.onTime !== null);
        const totalOnTimeEligible = stopsWithOnTime.length;
        const onTimeCount = stopsWithOnTime.filter(s => s.onTime).length;
        const onTimePct = totalOnTimeEligible
          ? Math.round((onTimeCount / totalOnTimeEligible) * 100)
          : 0;

        const metricOnTime = document.getElementById('metricOnTime');
        const metricOnTimeSub = document.getElementById('metricOnTimeSub');
        const metricStops = document.getElementById('metricStops');
        const metricStopsSub = document.getElementById('metricStopsSub');
        const metricDuration = document.getElementById('metricDuration');
        const metricDurationSub = document.getElementById('metricDurationSub');

        metricStops.textContent = perStop.length;
        metricStopsSub.textContent = perStop.length
          ? 'Distinct stops for this facility.'
          : 'No stops found for this facility.';
        metricOnTime.textContent = onTimePct + '%';
        metricOnTimeSub.textContent =
          totalOnTimeEligible > 0
            ? onTimeCount + ' of ' + totalOnTimeEligible + ' deliveries on time (15 min grace).'
            : 'No stops with both scheduled + delivered timestamps.';
        metricDuration.textContent = avgDuration + ' min';
        metricDurationSub.textContent = durations.length
          ? 'Based on ' + durations.length + ' stop(s) with start+end events.'
          : 'No complete duration data.';

        const maxDuration = durations.length ? Math.max(...durations) : 1;

        perStop.forEach(s => {
          const tr = document.createElement('tr');
          const schedStr = s.scheduled ? carelineFormatDateTimeShort(s.scheduled) : '—';
          const delStr = s.deliveredAt ? carelineFormatDateTimeShort(s.deliveredAt) : '—';
          const onTimeText =
            s.onTime === null ? 'N/A' : s.onTime ? 'Yes' : 'No';
          const durText = s.durationMin != null ? s.durationMin : '—';
          const relWidth =
            s.durationMin != null
              ? (Math.max(1, maxDuration - s.durationMin + 1) / (maxDuration + 1)) * 100
              : 0;

          tr.innerHTML = `
            <td>${s.stopId}</td>
            <td>${s.patientName || '—'}</td>
            <td>${schedStr}</td>
            <td>${delStr}</td>
            <td>${onTimeText}</td>
            <td>${durText}</td>
            <td class="bar-cell">${s.durationMin != null ? buildBarFill(relWidth) : ''}</td>
          `;
          stopsBody.appendChild(tr);
        });

        if (perStop.length) {
          stopsCount.textContent =
            'Showing ' + perStop.length + ' stop(s) for this facility.';
        }
      } catch (err) {
        console.error('Facility report error', err);
        errBox.style.display = 'block';
        errBox.textContent = 'Error loading facility report: ' + err.message;
        document.getElementById('stopsCount').textContent = 'Error loading data.';
      }
    }

    document.getElementById('applyBtn').addEventListener('click', loadFacilityReport);
    document.getElementById('resetBtn').addEventListener('click', () => {
      const today = new Date();
      const thirtyAgo = new Date(today.getTime() - 29 * 24 * 60 * 60 * 1000);
      document.getElementById('endDate').value = today.toISOString().slice(0, 10);
      document.getElementById('startDate').value = thirtyAgo.toISOString().slice(0, 10);
      document.getElementById('facilityNameInput').value = '';
      loadFacilityReport();
    });

    // Boot – admin or facility
    requireLoggedIn();
    CareLine.requireRole(['admin', 'facility']);
    buildRoleAwareNav('facility-report');
    updateSessionLabel();

    (function initDates() {
      const today = new Date();
      const thirtyAgo = new Date(today.getTime() - 29 * 24 * 60 * 60 * 1000);
      document.getElementById('endDate').value = today.toISOString().slice(0, 10);
      document.getElementById('startDate').value = thirtyAgo.toISOString().slice(0, 10);
    })();

    loadFacilityReport();
  </script>
</body>
</html>
