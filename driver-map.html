<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CareLine Driver Map | CareLine Medical Logistics</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #e6f7fb;
    }

    header {
      background-color: #0097a7;
      color: #ffffff;
      padding: 14px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .logo-title {
      font-size: 18px;
      font-weight: bold;
    }

    .badge {
      background: #004d40;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
    }

    .layout {
      display: flex;
      flex-direction: row;
      height: calc(100vh - 60px);
    }

    .left-panel {
      width: 320px;
      max-width: 100%;
      background: #fdfefe;
      border-right: 1px solid #d0e4ec;
      padding: 14px;
      box-sizing: border-box;
      overflow-y: auto;
    }

    .panel-title {
      font-weight: bold;
      margin-bottom: 6px;
      color: #004d40;
    }

    .panel-sub {
      font-size: 13px;
      color: #555;
      margin-bottom: 10px;
    }

    select,
    button {
      width: 100%;
      padding: 8px 10px;
      margin-bottom: 8px;
      border-radius: 6px;
      border: 1px solid #cfd8dc;
      font-size: 14px;
      box-sizing: border-box;
    }

    button {
      cursor: pointer;
      border: none;
      font-weight: 600;
    }

    .btn-primary {
      background: #0097a7;
      color: #fff;
    }

    .btn-outline {
      background: #ffffff;
      color: #006064;
      border: 1px solid #0097a7;
    }

    .btn-warning {
      background: #ff9800;
      color: #fff;
    }

    .btn-secondary {
      background: #eceff1;
      color: #37474f;
    }

    .status-badge {
      display: inline-block;
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 99px;
      background: #e0f2f1;
      color: #004d40;
      margin-top: 4px;
    }

    .last-update {
      font-size: 12px;
      color: #546e7a;
      margin-top: 6px;
    }

    .map-container {
      flex: 1;
      position: relative;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    .legend {
      position: absolute;
      bottom: 12px;
      left: 12px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 8px;
      padding: 8px 10px;
      font-size: 11px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
    }

    .legend-row {
      display: flex;
      align-items: center;
      margin-bottom: 4px;
    }

    .legend-color {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 6px;
    }

    .legend-driver {
      background: #ff5722;
    }

    .legend-stop {
      background: #0097a7;
    }

    .legend-planned {
      background: #9c27b0;
    }

    .small {
      font-size: 11px;
      color: #607d8b;
    }

    @media (max-width: 800px) {
      .layout {
        flex-direction: column;
      }
      .left-panel {
        width: 100%;
        max-height: 260px;
      }
      .map-container {
        height: calc(100vh - 60px - 260px);
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="logo-title">ðŸšš CareLine Driver Map</div>
    <div class="badge">Real-Time Route View</div>
  </header>

  <div class="layout">
    <aside class="left-panel">
      <div class="panel-title">Driver & Route</div>
      <div class="panel-sub">
        Pick a driver and choose how you want to view the route.  
        <span class="small">Route data comes from <code>routes.json</code>.</span>
      </div>

      <label for="driverSelect" style="font-size: 13px; font-weight: 600; color:#37474f;">Who is driving?</label>
      <select id="driverSelect"></select>

      <button id="btnCenterRoute" class="btn-outline">
        Center map on full route
      </button>

      <button id="btnDriverFollow" class="btn-secondary">
        Center on current driver position
      </button>

      <button id="btnStartShare" class="btn-primary">
        Start LIVE GPS sharing (driver phone)
      </button>

      <button id="btnStopShare" class="btn-warning">
        Stop LIVE GPS sharing
      </button>

      <div class="status-badge" id="shareStatus">
        GPS sharing: idle
      </div>

      <div class="last-update" id="lastGpsUpdate">
        Driver location: waiting for first updateâ€¦
      </div>

      <hr style="margin:14px 0;" />

      <div class="panel-title">How this works</div>
      <div class="small">
        â€¢ Drivers open this page on their phone and tap **Start LIVE GPS sharing**.  
        â€¢ Their location is sent to <code>/api/location</code> every few seconds.  
        â€¢ Admin, patients, or facilities can open the same URL to watch the driver move in real time.
      </div>
    </aside>

    <section class="map-container">
      <div id="map"></div>
      <div class="legend">
        <div class="legend-row">
          <div class="legend-color legend-driver"></div>
          <span>Live driver position</span>
        </div>
        <div class="legend-row">
          <div class="legend-color legend-stop"></div>
          <span>Route stops</span>
        </div>
        <div class="legend-row">
          <div class="legend-color legend-planned"></div>
          <span>Planned route path</span>
        </div>
        <div class="small" style="margin-top:4px;">
          This map auto-refreshes every 5 seconds using <code>routes.json</code> and <code>gps.json</code>.
        </div>
      </div>
    </section>
  </div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    // ===============================
    // CONFIG
    // ===============================
    const DEFAULT_CENTER = [39.2904, -76.6122]; // Baltimore
    const REFRESH_MS = 5000;

    // Read driverId from ?driverId= in URL, fallback later
    const urlParams = new URLSearchParams(window.location.search);
    let currentDriverId = urlParams.get('driverId') || null;

    let map, routeLayer, driverMarker;
    let gpsTimer = null;
    let pollTimer = null;
    let isSharing = false;

    const driverSelect = document.getElementById('driverSelect');
    const shareStatus = document.getElementById('shareStatus');
    const lastGpsUpdate = document.getElementById('lastGpsUpdate');
    const btnStartShare = document.getElementById('btnStartShare');
    const btnStopShare = document.getElementById('btnStopShare');
    const btnCenterRoute = document.getElementById('btnCenterRoute');
    const btnDriverFollow = document.getElementById('btnDriverFollow');

    // ===============================
    // MAP INIT
    // ===============================
    function initMap() {
      map = L.map('map').setView(DEFAULT_CENTER, 9);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      routeLayer = L.layerGroup().addTo(map);
    }

    // ===============================
    // LOAD ROUTES + POPULATE DRIVER LIST
    // ===============================
    async function loadRoutesAndDrivers() {
      try {
        const res = await fetch('/routes.json', { cache: 'no-store' });
        const data = await res.json();

        driverSelect.innerHTML = '';

        data.drivers.forEach(driver => {
          const opt = document.createElement('option');
          opt.value = driver.id;
          opt.textContent = driver.name;
          driverSelect.appendChild(opt);
        });

        // Set default driverId if not in URL
        if (!currentDriverId && data.drivers.length > 0) {
          currentDriverId = data.drivers[0].id;
        }

        driverSelect.value = currentDriverId;

        renderRouteForDriver(data, currentDriverId);

        driverSelect.addEventListener('change', () => {
          currentDriverId = driverSelect.value;
          renderRouteForDriver(data, currentDriverId, true);
        });

        // Also refresh route display every REFRESH_MS in case routes.json changes
        if (pollTimer) clearInterval(pollTimer);
        pollTimer = setInterval(async () => {
          try {
            const r2 = await fetch('/routes.json', { cache: 'no-store' });
            const d2 = await r2.json();
            renderRouteForDriver(d2, currentDriverId);
          } catch (err) {
            console.error('Route poll error', err);
          }
        }, REFRESH_MS);

      } catch (err) {
        console.error('Unable to load routes.json', err);
        alert('Unable to load route information (routes.json).');
      }
    }

    function renderRouteForDriver(routesData, driverId, fitBounds = true) {
      if (!routesData) return;

      const route = routesData.routes.find(r => r.driverId === driverId);
      routeLayer.clearLayers();

      if (!route || !route.stops || route.stops.length === 0) {
        return;
      }

      const latlngs = [];
      route.stops.forEach((stop, index) => {
        if (typeof stop.lat === 'number' && typeof stop.lng === 'number') {
          const marker = L.marker([stop.lat, stop.lng]).addTo(routeLayer);
          marker.bindPopup(
            `<strong>Stop ${index + 1} &mdash; ${stop.stopId}</strong><br/>
             <em>${stop.location || ''}</em><br/>
             Items: ${stop.items || 'n/a'}<br/>
             Status: ${stop.status || 'Unknown'}`
          );
          latlngs.push([stop.lat, stop.lng]);
        }
      });

      // Draw polyline for planned route
      if (latlngs.length > 1) {
        L.polyline(latlngs, { color: '#9c27b0', weight: 3 }).addTo(routeLayer);
      }

      if (fitBounds && latlngs.length > 0) {
        map.fitBounds(latlngs, { padding: [40, 40] });
      }
    }

    // ===============================
    // POLL GPS.JSON FOR LIVE DRIVER
    // ===============================
    async function pollGps() {
      if (!currentDriverId) return;

      try {
        const res = await fetch('/gps.json', { cache: 'no-store' });
        if (!res.ok) return; // file might not exist yet

        const data = await res.json();
        const driver = data.drivers && data.drivers[currentDriverId];
        if (!driver) {
          lastGpsUpdate.textContent = 'Driver location: no live data yet.';
          return;
        }

        const lat = parseFloat(driver.lat);
        const lng = parseFloat(driver.lng);
        if (isNaN(lat) || isNaN(lng)) return;

        const latlng = [lat, lng];

        if (!driverMarker) {
          driverMarker = L.marker(latlng, {
            title: 'Live driver position'
          }).addTo(map);
        } else {
          driverMarker.setLatLng(latlng);
        }

        lastGpsUpdate.textContent = `Driver location: ${lat.toFixed(5)}, ${lng.toFixed(
          5
        )} (updated ${new Date(driver.updated).toLocaleTimeString()})`;
      } catch (err) {
        console.error('GPS poll error', err);
      }
    }

    // ===============================
    // DRIVER SHARING (PHONE MODE)
// ===============================
    function startLiveSharing() {
      if (!navigator.geolocation) {
        alert('This device does not support GPS location.');
        return;
      }

      if (isSharing) return;
      isSharing = true;
      shareStatus.textContent = 'GPS sharing: active (sending every 5s)';

      gpsTimer = setInterval(() => {
        navigator.geolocation.getCurrentPosition(
          async pos => {
            try {
              await fetch('/api/location', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  driverId: currentDriverId,
                  lat: pos.coords.latitude,
                  lng: pos.coords.longitude
                })
              });
            } catch (err) {
              console.error('Error sending GPS location', err);
            }
          },
          err => {
            console.error('Geolocation error', err);
          },
          { enableHighAccuracy: true }
        );
      }, REFRESH_MS);
    }

    function stopLiveSharing() {
      isSharing = false;
      shareStatus.textContent = 'GPS sharing: idle';
      if (gpsTimer) {
        clearInterval(gpsTimer);
        gpsTimer = null;
      }
    }

    // ===============================
    // BUTTON HOOKS
    // ===============================
    btnStartShare.addEventListener('click', startLiveSharing);
    btnStopShare.addEventListener('click', stopLiveSharing);

    btnCenterRoute.addEventListener('click', async () => {
      try {
        const res = await fetch('/routes.json', { cache: 'no-store' });
        const data = await res.json();
        renderRouteForDriver(data, currentDriverId, true);
      } catch (err) {
        console.error(err);
      }
    });

    btnDriverFollow.addEventListener('click', async () => {
      await pollGps();
      if (driverMarker) {
        map.setView(driverMarker.getLatLng(), 13);
      }
    });

    // ===============================
    // BOOT
    // ===============================
    initMap();
    loadRoutesAndDrivers().then(() => {
      pollGps();
      setInterval(pollGps, REFRESH_MS);
    });
  </script>
</body>
</html>
