<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CareLine Notifications Timeline</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --teal: #0097a7;
      --dark: #004d40;
      --bg: #e0f7fa;
      --card: #ffffff;
      --muted: #607d8b;
      --danger: #c62828;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--dark);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background: var(--teal);
      color: #fff;
      padding: 12px 18px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .brand {
      font-weight: bold;
      font-size: 17px;
    }

    .subtitle {
      font-size: 11px;
      opacity: 0.9;
    }

    .nav {
      display: flex;
      gap: 10px;
      font-size: 12px;
    }

    .nav a {
      color: #e0f7fa;
      text-decoration: none;
      padding: 4px 8px;
      border-radius: 999px;
    }

    .nav a:hover {
      background: rgba(255,255,255,0.15);
    }

    .nav a.active {
      background: rgba(255,255,255,0.2);
    }

    main {
      flex: 1;
      padding: 14px;
      max-width: 1200px;
      width: 100%;
      margin: 0 auto;
    }

    h1 {
      font-size: 20px;
      margin-bottom: 4px;
    }

    .small {
      font-size: 11px;
      color: var(--muted);
    }

    .top-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 10px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .card {
      background: var(--card);
      border-radius: 12px;
      padding: 10px 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      margin-bottom: 12px;
    }

    .session-pill {
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px;
    }

    .error {
      padding: 8px;
      background: #ffebee;
      color: var(--danger);
      border-radius: 8px;
      font-size: 12px;
      margin-bottom: 8px;
      display: none;
    }

    .filters-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 6px;
    }

    label {
      font-size: 12px;
      color: #455a64;
    }

    select,
    input[type="text"],
    input[type="date"] {
      padding: 7px 9px;
      border-radius: 8px;
      border: 1px solid #b0bec5;
      font-size: 13px;
    }

    input[type="checkbox"] {
      transform: scale(0.9);
      margin-right: 3px;
    }

    button {
      font-size: 12px;
      padding: 7px 11px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
    }

    button.primary {
      background: var(--teal);
      color: #ffffff;
      font-weight: 600;
    }

    button.secondary {
      background: #eceff1;
      color: var(--dark);
    }

    button:active {
      transform: scale(0.98);
    }

    .live-pill {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      font-size: 11px;
      border-radius: 999px;
      padding: 3px 8px;
      background: #e3f2fd;
      color: #1565c0;
    }

    .live-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #d32f2f;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); opacity: 0.8; }
      50% { transform: scale(1.3); opacity: 1; }
      100% { transform: scale(1); opacity: 0.8; }
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      margin-top: 6px;
    }

    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #eceff1;
      text-align: left;
      vertical-align: top;
    }

    th {
      font-weight: 600;
      font-size: 11px;
      color: #455a64;
      white-space: nowrap;
    }

    tr:nth-child(even) {
      background: #fafafa;
    }

    .pill {
      display: inline-block;
      border-radius: 999px;
      padding: 2px 7px;
      font-size: 11px;
      background: #eceff1;
      color: #455a64;
    }

    .pill-sms {
      background: #fce4ec;
      color: #ad1457;
    }

    .pill-email {
      background: #e3f2fd;
      color: #1565c0;
    }

    .pill-status {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .count-pill {
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px;
    }

    .msg-preview {
      font-size: 11px;
      color: #455a64;
      max-width: 280px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    footer {
      font-size: 11px;
      text-align: center;
      padding: 8px 10px;
      color: var(--muted);
    }

    @media (max-width: 900px) {
      th:nth-child(5), td:nth-child(5) {
        display: none; /* hide message preview on small screens */
      }
    }
  </style>
</head>
<body>
  <header>
    <div>
      <div class="brand">CareLine Medical Logistics</div>
      <div class="subtitle">Notifications Timeline — SMS · Email · Status</div>
    </div>
    <nav class="nav" id="mainNav"></nav>
  </header>

  <main>
    <div class="top-row">
      <div>
        <h1>Notifications Feed</h1>
        <p class="small">
          Live timeline of every SMS, email, and status event across CareLine — with filters for channel, date, and facility.
        </p>
        <p class="session-pill" id="sessionUser">
          Checking current session…
        </p>
      </div>

      <section class="card" style="max-width:380px;">
        <h2 style="font-size:14px;margin-bottom:4px;">Live Status</h2>
        <p class="small">
          When <strong>Live Mode</strong> is ON, this page auto-refreshes every few seconds using your secure API token.
        </p>
        <div id="notifError" class="error"></div>

        <div class="filters-row" style="margin-top:6px;">
          <span id="liveIndicator" class="live-pill">
            <span class="live-dot"></span>
            Live: ON
          </span>
        </div>

        <div class="filters-row">
          <label>
            <input type="checkbox" id="liveToggle" checked />
            Auto-refresh every 10 seconds
          </label>
        </div>

        <div class="filters-row">
          <button id="manualRefreshBtn" class="secondary">Refresh now</button>
        </div>
      </section>
    </div>

    <section class="card">
      <!-- FILTERS -->
      <div class="filters-row">
        <div>
          <label for="channelFilter">Channel:</label>
          <select id="channelFilter">
            <option value="all">All</option>
            <option value="sms">SMS</option>
            <option value="email">Email</option>
            <option value="status">Status</option>
          </select>
        </div>

        <div>
          <label for="facilityFilter">Facility:</label>
          <input
            type="text"
            id="facilityFilter"
            placeholder="Type facility name..."
          />
        </div>

        <div>
          <label for="startDate">From:</label>
          <input type="date" id="startDate" />
        </div>

        <div>
          <label for="endDate">To:</label>
          <input type="date" id="endDate" />
        </div>
      </div>

      <div class="filters-row">
        <div>
          <label for="searchInput">Search:</label>
          <input
            type="text"
            id="searchInput"
            placeholder="Patient, status, driver, message..."
          />
        </div>
      </div>

      <!-- TABLE -->
      <table>
        <thead>
          <tr>
            <th>Time</th>
            <th>Channel</th>
            <th>Event</th>
            <th>Context</th>
            <th>Message Preview</th>
          </tr>
        </thead>
        <tbody id="notificationsBody">
          <!-- rows injected -->
        </tbody>
      </table>

      <p class="count-pill" id="notifCount">
        No notifications loaded yet.
      </p>
    </section>
  </main>

  <footer>
    CareLine Medical Logistics — Care That Moves. Logistics That Deliver.
  </footer>

  <script src="nav.js"></script>
  <script>
    // ==============================
    // UNIVERSAL TOKEN HELPERS
    // ==============================

    function getAuthHeaders() {
      const token = localStorage.getItem('carelineToken');
      return token ? { Authorization: 'Bearer ' + token } : {};
    }

    function requireLoggedIn() {
      const token = localStorage.getItem('carelineToken');
      if (!token) {
        alert('You must be logged in to view this page.');
        window.location.href = 'login.html';
      }
    }

    // ==============================
    // PAGE HELPERS
    // ==============================

    function updateSessionLabel() {
      const el = document.getElementById('sessionUser');
      const raw = localStorage.getItem('carelineUser');
      if (!raw) {
        el.textContent = 'Not logged in.';
        return;
      }
      try {
        const user = JSON.parse(raw);
        el.textContent =
          (user.email || user.id || 'User') + ' — ' + (user.role || 'unknown');
      } catch {
        el.textContent = 'Session found, but user data could not be read.';
      }
    }

    function channelPillClass(channel) {
      if (!channel) return 'pill';
      const c = String(channel).toLowerCase();
      if (c === 'sms') return 'pill pill-sms';
      if (c === 'email') return 'pill pill-email';
      if (c === 'status') return 'pill pill-status';
      return 'pill';
    }

    function formatTime(ts) {
      if (!ts) return '—';
      const d = new Date(ts);
      if (isNaN(d.getTime())) return '—';
      return d.toLocaleString();
    }

    function buildContextCell(ev) {
      const t = ev.templates || {};
      const bits = [];

      if (t.patientName) bits.push('Patient: ' + t.patientName);
      if (t.facilityName) bits.push('Facility: ' + t.facilityName);
      if (ev.driverId) bits.push('Driver: ' + ev.driverId);
      if (ev.stopId) bits.push('Stop: ' + ev.stopId);

      if (!bits.length) return '—';
      return bits.join(' · ');
    }

    function buildMessagePreview(ev) {
      const t = ev.templates || {};
      const msg =
        t.smsBody ||
        t.emailSubject ||
        t.emailBody ||
        ev.message ||
        ev.status ||
        ev.eventType ||
        '';
      if (!msg) return '';
      return msg.replace(/\s+/g, ' ').trim();
    }

    function matchesChannel(ev, filterValue) {
      if (filterValue === 'all') return true;
      const ch = (ev.channel || '').toLowerCase();
      return ch === filterValue;
    }

    function facilityMatches(ev, facilityTerm) {
      if (!facilityTerm) return true;
      const t = ev.templates || {};
      const name = (t.facilityName || '').toLowerCase();
      return name.includes(facilityTerm.toLowerCase());
    }

    function inDateRange(ev, startDate, endDate) {
      if (!startDate && !endDate) return true;
      if (!ev.createdAt) return false;
      const d = new Date(ev.createdAt);
      if (isNaN(d.getTime())) return false;

      if (startDate && d < startDate) return false;
      if (endDate && d > endDate) return false;
      return true;
    }

    function matchesSearch(ev, term) {
      if (!term) return true;
      const lower = term.toLowerCase();
      const t = ev.templates || {};

      const haystack = [
        ev.channel || '',
        ev.eventType || '',
        ev.status || '',
        ev.driverId || '',
        ev.stopId || '',
        t.patientName || '',
        t.facilityName || '',
        t.smsBody || '',
        t.emailSubject || '',
        t.emailBody || '',
        ev.message || ''
      ]
        .join(' ')
        .toLowerCase();

      return haystack.includes(lower);
    }

    // ==============================
    // LIVE NOTIFICATIONS LOGIC
    // ==============================

    let latestNotifications = [];
    let liveIntervalId = null;

    async function fetchNotifications() {
      const notifError = document.getElementById('notifError');
      const body = document.getElementById('notificationsBody');
      const countEl = document.getElementById('notifCount');

      notifError.style.display = 'none';
      notifError.textContent = '';

      try {
        const res = await fetch('/api/notifications', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            ...getAuthHeaders()
          },
          cache: 'no-store'
        });

        if (!res.ok) {
          notifError.style.display = 'block';
          notifError.textContent =
            'Could not load notifications. Check your access or token.';
          return;
        }

        const data = await res.json();
        const notifications = data.notifications || [];

        // Sort newest first
        latestNotifications = notifications.slice().sort((a, b) => {
          const ta = a.createdAt ? new Date(a.createdAt).getTime() : 0;
          const tb = b.createdAt ? new Date(b.createdAt).getTime() : 0;
          return tb - ta;
        });

        renderNotifications();
      } catch (err) {
        console.error('Notifications load error', err);
        notifError.style.display = 'block';
        notifError.textContent =
          'Network error while loading notifications.';
        body.innerHTML = '';
        countEl.textContent = 'Network error.';
      }
    }

    function renderNotifications() {
      const body = document.getElementById('notificationsBody');
      const countEl = document.getElementById('notifCount');
      const channelFilter = document.getElementById('channelFilter').value;
      const searchTerm = document.getElementById('searchInput').value.trim();
      const facilityTerm = document.getElementById('facilityFilter').value.trim();

      const startVal = document.getElementById('startDate').value;
      const endVal = document.getElementById('endDate').value;
      let startDate = null;
      let endDate = null;

      if (startVal) {
        startDate = new Date(startVal + 'T00:00:00');
      }
      if (endVal) {
        endDate = new Date(endVal + 'T23:59:59');
      }

      body.innerHTML = '';

      const filtered = latestNotifications.filter(ev => {
        return (
          matchesChannel(ev, channelFilter) &&
          facilityMatches(ev, facilityTerm) &&
          inDateRange(ev, startDate, endDate) &&
          matchesSearch(ev, searchTerm)
        );
      });

      if (!filtered.length) {
        countEl.textContent = 'No notifications match the current filters.';
        return;
      }

      filtered.forEach(ev => {
        const tr = document.createElement('tr');

        const channel = ev.channel || '';
        const eventType = ev.eventType || '';
        const status = ev.status || '';
        const context = buildContextCell(ev);
        const msgPreview = buildMessagePreview(ev);

        tr.innerHTML = `
          <td>${formatTime(ev.createdAt)}</td>
          <td><span class="${channelPillClass(channel)}">${channel || '—'}</span></td>
          <td>${eventType || status || '—'}</td>
          <td>${context}</td>
          <td><span class="msg-preview" title="${msgPreview.replace(/"/g, '&quot;')}">${msgPreview}</span></td>
        `;
        body.appendChild(tr);
      });

      countEl.textContent = 'Showing ' + filtered.length + ' event(s).';
    }

    function startLiveUpdates() {
      const liveIndicator = document.getElementById('liveIndicator');
      if (liveIntervalId) clearInterval(liveIntervalId);

      liveIndicator.innerHTML = '<span class="live-dot"></span>Live: ON';

      // First immediate fetch
      fetchNotifications();

      // Then auto-refresh
      liveIntervalId = setInterval(fetchNotifications, 10000); // 10 seconds
    }

    function stopLiveUpdates() {
      const liveIndicator = document.getElementById('liveIndicator');
      if (liveIntervalId) {
        clearInterval(liveIntervalId);
        liveIntervalId = null;
      }
      liveIndicator.innerHTML = 'Live: OFF';
    }

    // ==============================
    // EVENT LISTENERS & BOOT
    // ==============================

    document.getElementById('manualRefreshBtn').addEventListener('click', () => {
      fetchNotifications();
    });

    document.getElementById('channelFilter').addEventListener('change', () => {
      renderNotifications();
    });

    document.getElementById('searchInput').addEventListener('input', () => {
      renderNotifications();
    });

    document.getElementById('facilityFilter').addEventListener('input', () => {
      renderNotifications();
    });

    document.getElementById('startDate').addEventListener('change', () => {
      renderNotifications();
    });

    document.getElementById('endDate').addEventListener('change', () => {
      renderNotifications();
    });

    document.getElementById('liveToggle').addEventListener('change', (e) => {
      if (e.target.checked) {
        startLiveUpdates();
      } else {
        stopLiveUpdates();
      }
    });

    // Boot
    requireLoggedIn();
    buildRoleAwareNav('notifications');
    updateSessionLabel();

    // Default: show last 3 days
    (function initDefaultDates() {
      const end = new Date();
      const start = new Date(end.getTime() - 2 * 24 * 60 * 60 * 1000);
      document.getElementById('endDate').value = end.toISOString().slice(0, 10);
      document.getElementById('startDate').value = start.toISOString().slice(0, 10);
    })();

    startLiveUpdates();
  </script>
</body>
</html>
