<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Driver Route | CareLine Medical Logistics</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f2f7f9;
      margin: 0;
      padding: 0;
    }
    header {
      background-color: #0097a7;
      color: white;
      text-align: center;
      padding: 20px 0;
      font-size: 22px;
      font-weight: bold;
    }
    .driver-select {
      max-width: 700px;
      margin: 15px auto 10px;
      background: #ffffff;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      font-size: 15px;
      color: #006064;
    }
    .driver-select select {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      font-size: 15px;
      border: 1px solid #b0bec5;
      margin-top: 6px;
    }
    .route-container {
      max-width: 700px;
      margin: 10px auto 20px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      padding: 18px 18px 20px;
    }
    .route-info {
      background-color: #f1fbfc;
      border-radius: 8px;
      border: 1px solid #cfd8dc;
      padding: 10px 12px;
      margin-bottom: 10px;
      font-size: 13px;
      color: #455a64;
    }
    .route-info-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }
    .route-name {
      font-size: 15px;
      font-weight: bold;
      color: #004d60;
    }
    .route-meta {
      font-size: 12px;
      color: #607d8b;
    }
    .route-notes {
      font-size: 12px;
      color: #607d8b;
      margin-top: 2px;
    }

    /* Progress bar */
    .route-progress {
      margin-bottom: 14px;
    }
    .route-progress-label {
      font-size: 12px;
      color: #455a64;
      margin-bottom: 4px;
    }
    .route-progress-bar {
      width: 100%;
      height: 10px;
      background-color: #e0e0e0;
      border-radius: 999px;
      overflow: hidden;
    }
    .route-progress-fill {
      height: 100%;
      width: 0%;
      background-color: #0097a7;
      border-radius: 999px;
      transition: width 0.3s ease;
    }

    /* Overview map */
    .overview-map {
      margin-bottom: 14px;
    }
    .overview-map iframe {
      width: 100%;
      height: 220px;
      border: 0;
      border-radius: 8px;
    }

    .stop {
      background: #e0f7fa;
      margin-bottom: 15px;
      border-radius: 8px;
      padding: 15px;
      cursor: pointer;
      border: 1px solid transparent;
    }
    .stop-completed {
      background: #c8e6c9;
      border-color: #2e7d32;
    }
    .stop h3 {
      margin: 0;
      color: #00796b;
    }
    .details {
      display: none;
      padding-top: 10px;
    }
    .show { display: block; }
    .details p {
      margin: 4px 0;
    }
    .status-select-label {
      font-size: 14px;
      margin-top: 6px;
      color: #004d60;
    }
    .status-select {
      width: 100%;
      margin-top: 2px;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #b0bec5;
      font-size: 13px;
    }
    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }
    button.upload-proof,
    button.unable-btn {
      background-color: #0097a7;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    button.upload-proof:hover,
    button.unable-btn:hover {
      background-color: #007b83;
    }
    .thumbnail img {
      margin-top: 10px;
      border-radius: 8px;
      width: 120px;
    }
    .customer-link {
      display: inline-block;
      margin-top: 8px;
      text-decoration: none;
      background-color: white;
      border: 1px solid #0097a7;
      color: #0097a7;
      padding: 7px 12px;
      border-radius: 6px;
      font-size: 13px;
      margin-right: 4px;
    }
    .mini-map {
      margin-top: 10px;
    }
    .mini-map iframe {
      width: 100%;
      height: 160px;
      border: 0;
      border-radius: 8px;
    }
    .no-route {
      text-align: center;
      color: #607d8b;
      font-size: 14px;
      padding-top: 8px;
    }
  </style>
</head>
<body>

<header>
  üöö CareLine Driver Route
</header>

<div class="driver-select">
  <strong>Who is driving?</strong>
  <select id="driverName">
    <option>Max (CareLine Driver)</option>
    <option>Lena (CareLine Driver)</option>
    <option>Chris (CareLine Driver)</option>
    <option>James (CareLine Driver)</option>
  </select>
</div>

<div class="route-container">
  <div id="routeInfo" class="route-info">
    Loading route info...
  </div>

  <!-- Progress bar -->
  <div id="routeProgress" class="route-progress">
    <div class="route-progress-label">
      Progress: <span id="progressText">0 of 0 stops complete (0%)</span>
    </div>
    <div class="route-progress-bar">
      <div id="progressFill" class="route-progress-fill"></div>
    </div>
  </div>

  <!-- Overview map -->
  <div id="overviewMap" class="overview-map"></div>

  <!-- Stops -->
  <div id="routeStops">
    Loading route...
  </div>
</div>

<script>
  let allStops = [];
  let routeMeta = {};
  let completedStops = {}; // stopId => true when proof uploaded this session

  function getDriverName() {
    return document.getElementById("driverName").value;
  }

  function toggleDetails(id) {
    document.querySelectorAll('.details').forEach(d => d.classList.remove('show'));
    const el = document.getElementById(id);
    if (el) el.classList.add('show');
  }

  function formatStatusText(status, reason) {
    let base;
    if (status === 'Delivered') base = 'Status: Delivered ‚úîÔ∏è';
    else if (status === 'Attempted - No Answer') base = 'Status: Attempted ‚Äì No Answer ‚ö†Ô∏è';
    else if (status === 'Left with Staff') base = 'Status: Left with Staff üßë‚Äç‚öïÔ∏è';
    else base = 'Status: ' + status;

    if (reason) {
      base += ` (Reason: ${reason})`;
    }
    return base;
  }

  function getFilteredStopsForCurrentDriver() {
    const currentDriver = getDriverName();
    if (!allStops || allStops.length === 0) return [];

    return allStops.filter(stop => {
      if (!stop.drivers || !Array.isArray(stop.drivers) || stop.drivers.length === 0) {
        return true; // no drivers field = all drivers
      }
      return stop.drivers.includes(currentDriver);
    });
  }

  function updateProgress() {
    const filtered = getFilteredStopsForCurrentDriver();
    const total = filtered.length;
    const completed = filtered.filter(s => completedStops[s.id]).length;
    const percent = total === 0 ? 0 : Math.round((completed / total) * 100);

    const textEl = document.getElementById('progressText');
    const fillEl = document.getElementById('progressFill');

    if (textEl) {
      textEl.textContent = `${completed} of ${total} stops complete (${percent}%)`;
    }
    if (fillEl) {
      fillEl.style.width = percent + '%';
    }
  }

  async function startUpload(event, stopId, facilityName, forcedStatus, extraFields) {
    if (event) event.stopPropagation();

    const driver = getDriverName();
    const status = forcedStatus || 'Delivered';

    const input = document.createElement("input");
    input.type = "file";
    input.accept = "image/*";
    input.capture = "environment";

    input.onchange = async () => {
      const file = input.files[0];
      if (!file) return;

      let gps = { lat: null, lng: null };
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          pos => {
            gps.lat = pos.coords.latitude;
            gps.lng = pos.coords.longitude;
          }
        );
      }

      await new Promise(r => setTimeout(r, 800));

      const formData = new FormData();
      formData.append("photo", file);
      formData.append("stopId", stopId);
      formData.append("timestamp", new Date().toISOString());
      formData.append("lat", gps.lat);
      formData.append("lng", gps.lng);
      formData.append("facilityName", facilityName);
      formData.append("driverName", driver);
      formData.append("status", status);

      if (extraFields && extraFields.unableReason) {
        formData.append("unableReason", extraFields.unableReason);
      }

      const res = await fetch("http://localhost:3000/uploadProof", {
        method: "POST",
        body: formData
      });

      const data = await res.json();
      alert("üì∏ Delivery Uploaded!");

      const thumbEl = document.getElementById("thumb-" + stopId);
      const statusTextEl = document.getElementById("statusText-" + stopId);
      const trackingEl = document.getElementById("tracking-" + stopId);
      const customerLinkEl = document.getElementById("link-" + stopId);
      const clinicLinkEl = document.getElementById("clinic-" + stopId);
      const stopCard = document.querySelector(`.stop[data-stop-id="${stopId}"]`);

      if (thumbEl) {
        thumbEl.innerHTML = `<img src="${data.fileUrl}">`;
      }
      if (statusTextEl) {
        statusTextEl.innerText = formatStatusText(
          data.status || status,
          extraFields ? extraFields.unableReason : undefined
        );
      }
      if (trackingEl) {
        trackingEl.innerText = "Tracking ID: " + data.trackingCode;
      }
      if (customerLinkEl) {
        customerLinkEl.href = `tracking.html?code=${encodeURIComponent(data.trackingCode)}`;
      }
      if (clinicLinkEl) {
        clinicLinkEl.href = `tracking-hospital.html?code=${encodeURIComponent(data.trackingCode)}`;
      }
      if (stopCard) {
        stopCard.classList.add('stop-completed');
      }

      // mark as completed + update progress
      completedStops[stopId] = true;
      updateProgress();

      // Auto-advance to next stop
      const filtered = getFilteredStopsForCurrentDriver();
      const idx = filtered.findIndex(s => s.id === stopId);
      if (idx >= 0 && idx < filtered.length - 1) {
        const nextId = filtered[idx + 1].id;
        const nextDetails = document.getElementById(nextId);
        const nextCard = document.querySelector(`.stop[data-stop-id="${nextId}"]`);
        if (nextCard) {
          nextCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        if (nextDetails) {
          toggleDetails(nextId);
        }
      }
    };

    input.click();
  }

  function uploadProof(event, stopId, facilityName) {
    // Use whatever is in the status dropdown
    const statusSelect = document.getElementById("statusSelect-" + stopId);
    const chosenStatus = statusSelect ? statusSelect.value : 'Delivered';
    startUpload(event, stopId, facilityName, chosenStatus, {});
  }

  function markUnable(event, stopId, facilityName) {
    event.stopPropagation();
    const reason = prompt(
      "Unable to deliver. Choose or type a reason:\n\n" +
      "1) Patient Not Home\n" +
      "2) Gate Locked\n" +
      "3) Facility Closed\n\n" +
      "Or type your own reason."
    );

    if (!reason) {
      return; // user cancelled
    }

    const statusSelect = document.getElementById("statusSelect-" + stopId);
    if (statusSelect) {
      statusSelect.value = "Attempted - No Answer";
    }

    startUpload(event, stopId, facilityName, "Attempted - No Answer", {
      unableReason: reason
    });
  }

  function buildOverviewMap(filteredStops) {
    const overviewEl = document.getElementById('overviewMap');
    const stopsWithCoords = filteredStops.filter(s =>
      typeof s.lat === 'number' && typeof s.lng === 'number'
    );

    if (!overviewEl) return;

    if (!stopsWithCoords || stopsWithCoords.length === 0) {
      overviewEl.innerHTML = '';
      return;
    }

    const sum = stopsWithCoords.reduce(
      (acc, s) => {
        acc.lat += s.lat;
        acc.lng += s.lng;
        return acc;
      },
      { lat: 0, lng: 0 }
    );
    const avgLat = sum.lat / stopsWithCoords.length;
    const avgLng = sum.lng / stopsWithCoords.length;

    const url = `https://www.google.com/maps?q=${avgLat},${avgLng}&z=11&output=embed`;

    overviewEl.innerHTML = `
      <iframe src="${url}" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
    `;
  }

  function buildRouteUI() {
    const routeInfoEl = document.getElementById('routeInfo');
    const stopsContainer = document.getElementById('routeStops');
    const currentDriver = getDriverName();

    const name = routeMeta.routeName || 'CareLine Route';
    const date = routeMeta.routeDate || '';
    const dispatcher = routeMeta.dispatcher || '';
    const notes = routeMeta.notes || '';

    const filtered = getFilteredStopsForCurrentDriver();
    const stopCount = filtered.length;

    routeInfoEl.innerHTML = `
      <div class="route-info-top">
        <div class="route-name">${name}</div>
        <div class="route-meta">
          ${date ? `Date: ${date}` : ''}${date && dispatcher ? ' ¬∑ ' : ''}${dispatcher ? `Dispatcher: ${dispatcher}` : ''}
        </div>
      </div>
      <div class="route-meta">
        Assigned driver: <strong>${currentDriver}</strong> ¬∑ Stops on this route: <strong>${stopCount}</strong>
      </div>
      ${notes ? `<div class="route-notes">${notes}</div>` : ''}
    `;

    // Overview map for current driver's route
    buildOverviewMap(filtered);

    if (!filtered || filtered.length === 0) {
      stopsContainer.innerHTML = `
        <div class="no-route">
          No stops assigned to <strong>${currentDriver}</strong> on this route.<br>
          Check routes.json or choose a different driver.
        </div>
      `;
      updateProgress();
      return;
    }

    // Build stop cards
    stopsContainer.innerHTML = '';
    filtered.forEach(stop => {
      const safeFacility = (stop.facility || '').replace(/'/g, "\\'");
      const statusLine = completedStops[stop.id]
        ? formatStatusText('Delivered')
        : 'Status: Not Delivered ‚ùå';

      const completedClass = completedStops[stop.id] ? 'stop-completed' : '';

      const hasCoords = typeof stop.lat === 'number' && typeof stop.lng === 'number';
      const miniMapHtml = hasCoords
        ? `
          <div class="mini-map">
            <iframe
              src="https://www.google.com/maps?q=${stop.lat},${stop.lng}&z=15&output=embed"
              loading="lazy"
              referrerpolicy="no-referrer-when-downgrade"
            ></iframe>
          </div>
        `
        : '';

      const html = `
        <div class="stop ${completedClass}" data-stop-id="${stop.id}" onclick="toggleDetails('${stop.id}')">
          <h3>${stop.title}</h3>
          <div class="details" id="${stop.id}">
            <p><strong>Facility:</strong> ${stop.facility}</p>
            <p><strong>Items:</strong> ${stop.items}</p>
            <p id="statusText-${stop.id}">${statusLine}</p>
            <p id="tracking-${stop.id}">Tracking ID: ${completedStops[stop.id] ? '(loaded this session)' : '‚Äî'}</p>

            <div class="status-select-label">Delivery Status:</div>
            <select id="statusSelect-${stop.id}" class="status-select">
              <option value="Delivered">Delivered</option>
              <option value="Attempted - No Answer">Attempted ‚Äì No Answer</option>
              <option value="Left with Staff">Left with Staff</option>
            </select>

            <div class="thumbnail" id="thumb-${stop.id}"></div>

            <div class="btn-row">
              <button class="upload-proof" onclick="uploadProof(event, '${stop.id}', '${safeFacility}')">
                üì∏ Upload Proof
              </button>
              <button class="unable-btn" onclick="markUnable(event, '${stop.id}', '${safeFacility}')">
                ‚ö†Ô∏è Unable to Deliver
              </button>
            </div>

            <a id="link-${stop.id}" class="customer-link" href="#" target="_blank">View Customer</a>
            <a id="clinic-${stop.id}" class="customer-link" href="#" target="_blank">Facility View</a>

            ${miniMapHtml}
          </div>
        </div>
      `;
      stopsContainer.insertAdjacentHTML('beforeend', html);
    });

    // Auto-open first stop
    if (filtered.length > 0) {
      toggleDetails(filtered[0].id);
    }

    updateProgress();
  }

  async function loadStops() {
    const routeInfoEl = document.getElementById('routeInfo');
    const stopsContainer = document.getElementById('routeStops');

    routeInfoEl.textContent = 'Loading route info...';
    stopsContainer.textContent = 'Loading route...';

    try {
      const res = await fetch('http://localhost:3000/routes.json');
      if (!res.ok) throw new Error('Unable to load routes.json');
      const data = await res.json();
      allStops = data.stops || [];
      routeMeta = data;
      buildRouteUI();
    } catch (err) {
      console.error(err);
      routeInfoEl.textContent = 'Unable to load route info.';
      stopsContainer.innerHTML = '<div class="no-route">Unable to load route definition (routes.json).</div>';
      updateProgress();
    }
  }

  window.addEventListener('load', () => {
    loadStops();
    const driverSelect = document.getElementById('driverName');
    driverSelect.addEventListener('change', buildRouteUI);
  });
</script>

</body>
</html>
