<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CareLine Control Center | Live Dispatch Dashboard</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #e3f2fd;
      color: #263238;
    }

    header {
      background: #006064;
      color: #fff;
      padding: 14px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .title {
      font-size: 18px;
      font-weight: bold;
    }

    .subtitle {
      font-size: 12px;
      opacity: 0.9;
    }

    .pill {
      background: #004d40;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
    }

    .layout {
      display: grid;
      grid-template-columns: 2fr 1.4fr;
      grid-template-rows: auto 1fr;
      grid-template-areas:
        "summary map"
        "table map";
      gap: 12px;
      padding: 12px;
      height: calc(100vh - 56px);
      box-sizing: border-box;
    }

    .card {
      background: #ffffff;
      border-radius: 8px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
      padding: 10px 12px;
      box-sizing: border-box;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
    }

    .summary-card {
      padding: 10px;
      border-radius: 8px;
      color: #ffffff;
    }

    .s-total { background: #006064; }
    .s-out { background: #0288d1; }
    .s-complete { background: #2e7d32; }
    .s-alerts { background: #e64a19; }

    .summary-label {
      font-size: 11px;
      opacity: 0.9;
    }

    .summary-value {
      font-size: 20px;
      font-weight: bold;
    }

    #tableCard {
      grid-area: table;
      overflow: auto;
    }

    #summaryCard {
      grid-area: summary;
    }

    #mapCard {
      grid-area: map;
      display: flex;
      flex-direction: column;
    }

    #map {
      flex: 1;
      min-height: 260px;
      border-radius: 8px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    thead {
      background: #eceff1;
    }

    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #eceff1;
      text-align: left;
    }

    th {
      font-weight: 600;
      font-size: 12px;
      color: #455a64;
    }

    tr:nth-child(even) {
      background: #fafafa;
    }

    .tag {
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 11px;
      display: inline-block;
    }

    .tag-out { background: #e3f2fd; color: #1565c0; }
    .tag-complete { background: #e8f5e9; color: #2e7d32; }
    .tag-alert { background: #ffebee; color: #c62828; }
    .tag-pending { background: #fff8e1; color: #ef6c00; }

    .small {
      font-size: 11px;
      color: #607d8b;
      margin-top: 4px;
    }

    .map-footer {
      font-size: 11px;
      margin-top: 6px;
      color: #546e7a;
    }

    .btn-link {
      display: inline-block;
      padding: 4px 8px;
      font-size: 11px;
      border-radius: 999px;
      border: 1px solid #0097a7;
      color: #006064;
      text-decoration: none;
      margin-left: 6px;
    }

    .btn-link:hover {
      background: #e0f7fa;
    }

    .action-btn {
      padding: 3px 5px;
      font-size: 11px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      margin-right: 4px;
      margin-bottom: 2px;
      display: inline-block;
    }

    .action-link {
      background: #e0f7fa;
      color: #006064;
    }

    .action-sms {
      background: #fff3e0;
      color: #e65100;
    }

    .action-email {
      background: #ede7f6;
      color: #4527a0;
    }

    @media (max-width: 1000px) {
      .layout {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto auto;
        grid-template-areas:
          "summary"
          "map"
          "table";
        height: auto;
      }
      #map { min-height: 220px; }
    }
  </style>
</head>
<body>
  <header>
    <div>
      <div class="title">CareLine Control Center</div>
      <div class="subtitle">Live dispatch • Tracking • SMS & Email Hooks</div>
    </div>
    <div class="pill">Internal Operations Dashboard</div>
  </header>

  <main class="layout">
    <!-- SUMMARY CARD -->
    <section id="summaryCard" class="card">
      <div class="summary-grid">
        <div class="summary-card s-total">
          <div class="summary-label">Total Stops Today</div>
          <div id="totalStops" class="summary-value">0</div>
        </div>
        <div class="summary-card s-out">
          <div class="summary-label">Out for Delivery</div>
          <div id="outForDelivery" class="summary-value">0</div>
        </div>
        <div class="summary-card s-complete">
          <div class="summary-label">Completed</div>
          <div id="completed" class="summary-value">0</div>
        </div>
        <div class="summary-card s-alerts">
          <div class="summary-label">Needs Attention</div>
          <div id="alerts" class="summary-value">0</div>
        </div>
      </div>
      <div class="small">
        Auto-refresh every 5 seconds from <code>routes.json</code> and <code>gps.json</code>.
        <a href="driver-map.html" class="btn-link" target="_blank">Open Live Driver Map</a>
      </div>
    </section>

    <!-- TABLE CARD -->
    <section id="tableCard" class="card">
      <h3 style="margin:0 0 6px 0; font-size:14px;">Active Deliveries</h3>
      <table>
        <thead>
          <tr>
            <th>Driver</th>
            <th>Stop</th>
            <th>Location</th>
            <th>Items</th>
            <th>Status</th>
            <th>Last GPS</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="deliveriesBody">
          <!-- Rows injected by JS -->
        </tbody>
      </table>
      <div class="small" id="tableInfo">
        Waiting for first data load…
      </div>
    </section>

    <!-- MAP CARD -->
    <section id="mapCard" class="card">
      <h3 style="margin:0 0 6px 0; font-size:14px;">Live Map (All Drivers)</h3>
      <div id="map"></div>
      <div class="map-footer">
        • Green markers = stops • Orange markers = live driver positions  
        • Use this for dispatch, customer calls, and escalation.
      </div>
    </section>
  </main>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    const REFRESH_MS = 5000;
    const DEFAULT_CENTER = [39.2904, -76.6122];

    let map, mapLayer, driverMarkers = {};

    function initMap() {
      map = L.map('map').setView(DEFAULT_CENTER, 9);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);
      mapLayer = L.layerGroup().addTo(map);
    }

    async function loadDashboard() {
      try {
        const [routesRes, gpsRes] = await Promise.all([
          fetch('/routes.json', { cache: 'no-store' }),
          fetch('/gps.json', { cache: 'no-store' }).catch(() => null)
        ]);

        const routesData = await routesRes.json();
        let gpsData = null;
        if (gpsRes && gpsRes.ok) {
          gpsData = await gpsRes.json();
        }

        updateSummary(routesData);
        updateTable(routesData, gpsData);
        updateMap(routesData, gpsData);

      } catch (err) {
        console.error('Dashboard load error', err);
      }
    }

    function updateSummary(routesData) {
      let total = 0;
      let out = 0;
      let complete = 0;
      let alerts = 0;

      routesData.routes.forEach(route => {
        route.stops.forEach(stop => {
          total++;
          const status = (stop.status || '').toLowerCase();
          if (status.includes('complete')) complete++;
          else if (status.includes('out')) out++;
          else if (status.includes('issue') || status.includes('delayed')) alerts++;
          else alerts++; // unknown -> needs attention
        });
      });

      document.getElementById('totalStops').textContent = total;
      document.getElementById('outForDelivery').textContent = out;
      document.getElementById('completed').textContent = complete;
      document.getElementById('alerts').textContent = alerts;
    }

    function statusTag(status) {
      const s = (status || '').toLowerCase();
      if (s.includes('complete')) return '<span class="tag tag-complete">Completed</span>';
      if (s.includes('out')) return '<span class="tag tag-out">Out for delivery</span>';
      if (s.includes('issue') || s.includes('delay')) return '<span class="tag tag-alert">Issue</span>';
      return '<span class="tag tag-pending">Pending</span>';
    }

    function formatGpsTime(driverId, gpsData) {
      if (!gpsData || !gpsData.drivers || !gpsData.drivers[driverId]) {
        return '<span class="small">No live data</span>';
      }
      const d = gpsData.drivers[driverId];
      const t = new Date(d.updated);
      return `<span class="small">${t.toLocaleTimeString()}</span>`;
    }

    function updateTable(routesData, gpsData) {
      const body = document.getElementById('deliveriesBody');
      const info = document.getElementById('tableInfo');
      body.innerHTML = '';

      let rowCount = 0;

      routesData.routes.forEach(route => {
        const driver = routesData.drivers.find(d => d.id === route.driverId);
        const driverName = driver ? driver.name : route.driverId;

        route.stops.forEach((stop, index) => {
          const tr = document.createElement('tr');

          tr.innerHTML = `
            <td>${driverName}</td>
            <td>${index + 1} (${stop.stopId})</td>
            <td>${stop.location || ''}</td>
            <td>${stop.items || ''}</td>
            <td>${statusTag(stop.status)}</td>
            <td>${formatGpsTime(route.driverId, gpsData)}</td>
            <td>
              <button class="action-btn action-link" onclick="showTrackingLink('${stop.stopId}')">Link</button>
              <button class="action-btn action-sms" onclick="sendPatientSms('${stop.stopId}')">Send SMS</button>
              <button class="action-btn action-email" onclick="sendFacilityEmail('${stop.stopId}')">Facility Email</button>
            </td>
          `;

          body.appendChild(tr);
          rowCount++;
        });
      });

      info.textContent = rowCount === 0
        ? 'No active stops found in routes.json.'
        : `Showing ${rowCount} stops across ${routesData.routes.length} route(s).`;
    }

    function updateMap(routesData, gpsData) {
      mapLayer.clearLayers();
      driverMarkers = {};

      const bounds = [];

      // Stops (green)
      routesData.routes.forEach(route => {
        const driver = routesData.drivers.find(d => d.id === route.driverId);
        const driverName = driver ? driver.name : route.driverId;

        route.stops.forEach((stop, index) => {
          if (typeof stop.lat === 'number' && typeof stop.lng === 'number') {
            const m = L.marker([stop.lat, stop.lng], {
              title: `Stop ${index + 1} (${driverName})`
            }).addTo(mapLayer);
            m.bindPopup(
              `<strong>${driverName}</strong><br/>
               Stop ${index + 1} — ${stop.stopId}<br/>
               ${stop.location || ''}<br/>
               Items: ${stop.items || ''}<br/>
               Status: ${stop.status || 'Unknown'}`
            );
            bounds.push([stop.lat, stop.lng]);
          }
        });
      });

      // Live drivers (orange)
      if (gpsData && gpsData.drivers) {
        Object.keys(gpsData.drivers).forEach(driverId => {
          const d = gpsData.drivers[driverId];
          const lat = parseFloat(d.lat);
          const lng = parseFloat(d.lng);
          if (isNaN(lat) || isNaN(lng)) return;

          const driver = routesData.drivers.find(dr => dr.id === driverId);
          const driverName = driver ? driver.name : driverId;

          const marker = L.circleMarker([lat, lng], {
            radius: 8,
            color: '#ff5722',
            fillColor: '#ff5722',
            fillOpacity: 0.9
          }).addTo(mapLayer);

          marker.bindPopup(
            `<strong>${driverName}</strong><br/>
             Live position<br/>
             ${lat.toFixed(5)}, ${lng.toFixed(5)}<br/>
             Updated: ${new Date(d.updated).toLocaleTimeString()}`
          );

          bounds.push([lat, lng]);
          driverMarkers[driverId] = marker;
        });
      }

      if (bounds.length > 0) {
        map.fitBounds(bounds, { padding: [40, 40] });
      } else {
        map.setView(DEFAULT_CENTER, 9);
      }
    }

    // ============ NOTIFICATION ACTIONS ============

    async function showTrackingLink(stopId) {
      try {
        const res = await fetch('/api/share-link/' + encodeURIComponent(stopId));
        const data = await res.json();
        if (!data.success) {
          alert('Could not generate tracking link for this stop.');
          return;
        }
        const msg = `Tracking link for ${stopId}:\n\n${data.trackingUrl}\n\nCopy this into a text or email.`;
        alert(msg);
      } catch (err) {
        console.error('Error getting share link', err);
        alert('Error getting tracking link.');
      }
    }

    async function sendPatientSms(stopId) {
      const phone = prompt('Enter patient phone number (digits only):');
      if (!phone) return;
      try {
        const res = await fetch('/api/send-sms', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ stopId, phone })
        });
        const data = await res.json();
        if (!data.success) {
          alert('Could not send SMS. Check number or try again.');
          return;
        }
        alert(
          'SMS logged as sent to ' +
          phone +
          '.\n\nMessage:\n\n' +
          data.smsText
        );
      } catch (err) {
        console.error('Error sending SMS', err);
        alert('Error sending SMS.');
      }
    }

    async function sendFacilityEmail(stopId) {
      const email = prompt('Enter facility email address:');
      if (!email) return;
      try {
        const res = await fetch('/api/send-facility-email', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ stopId, email })
        });
        const data = await res.json();
        if (!data.success) {
          alert('Could not send email. Check address or try again.');
          return;
        }
        alert(
          'Email logged as sent to ' +
          email +
          '.\n\nSubject:\n' +
          data.emailPayload.subject +
          '\n\nBody:\n\n' +
          data.emailPayload.body
        );
      } catch (err) {
        console.error('Error sending email', err);
        alert('Error sending email.');
      }
    }

    // Boot
    initMap();
    loadDashboard();
    setInterval(loadDashboard, REFRESH_MS);
  </script>
</body>
</html>
