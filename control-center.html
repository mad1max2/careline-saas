<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CareLine Control Center</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #eef6f8;
            margin: 0;
            padding: 0;
        }
        header {
            background-color: #006a80;
            color: #fff;
            padding: 18px;
            text-align: center;
            font-size: 22px;
            font-weight: bold;
        }
        .wrapper {
            max-width: 900px;
            margin: 30px auto;
            background: #fff;
            padding: 20px 25px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            padding: 10px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 14px;
        }
        th {
            background: #f0f7f8;
            text-align: left;
        }
        .badge {
            padding: 3px 7px;
            border-radius: 10px;
            font-size: 12px;
            color: #fff;
        }
        .badge-ok {
            background: #2e7d32;
        }
        .badge-warn {
            background: #f57c00;
        }
        .small {
            font-size: 12px;
            color: #666;
        }
    </style>
</head>
<body>
<header>ðŸ“¡ CareLine Control Center</header>

<div class="wrapper">
    <h3>Driver Overview</h3>
    <p class="small">
        Live view of drivers, last known location, and route completion.
    </p>

    <table>
        <thead>
            <tr>
                <th>Driver</th>
                <th>Completed</th>
                <th>Remaining</th>
                <th>Last Location</th>
                <th>Last Update</th>
            </tr>
        </thead>
        <tbody id="driverTableBody"></tbody>
    </table>
</div>

<script>
async function fetchJSON(url) {
    const res = await fetch(url);
    if (!res.ok) throw new Error("Failed to load " + url);
    return await res.json();
}

async function loadDashboard() {
    try {
        const routes = await fetchJSON("/routes.json");
        const locs = await fetchJSON("/api/locations");

        const body = document.getElementById("driverTableBody");
        body.innerHTML = "";

        routes.drivers.forEach(driver => {
            const row = document.createElement("tr");

            const driverRoutes = routes.routes.filter(r => r.driverId === driver.id);
            let completed = 0;
            let remaining = 0;

            driverRoutes.forEach(r => {
                r.stops.forEach(s => {
                    if (s.status === "Completed") completed++;
                    else remaining++;
                });
            });

            const locEntry =
                locs.drivers && locs.drivers[driver.id]
                    ? locs.drivers[driver.id]
                    : null;

            const tdName = document.createElement("td");
            tdName.textContent = driver.name;
            row.appendChild(tdName);

            const tdComp = document.createElement("td");
            tdComp.innerHTML = `<span class="badge badge-ok">${completed}</span>`;
            row.appendChild(tdComp);

            const tdRem = document.createElement("td");
            tdRem.innerHTML = `<span class="badge badge-warn">${remaining}</span>`;
            row.appendChild(tdRem);

            const tdLoc = document.createElement("td");
            if (locEntry) {
                tdLoc.textContent = `${locEntry.lat.toFixed(5)}, ${locEntry.lng.toFixed(5)}`;
            } else {
                tdLoc.textContent = "No location yet";
            }
            row.appendChild(tdLoc);

            const tdTime = document.createElement("td");
            if (locEntry) {
                tdTime.textContent = new Date(locEntry.timestamp).toLocaleTimeString();
            } else {
                tdTime.textContent = "-";
            }
            row.appendChild(tdTime);

            body.appendChild(row);
        });
    } catch (err) {
        console.error("Dashboard error:", err);
    }
}

// Refresh every 15 seconds
loadDashboard();
setInterval(loadDashboard, 15000);
</script>
</body>
</html>
